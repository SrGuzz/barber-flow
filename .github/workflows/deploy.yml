name: ðŸš€ Deploy incremental via SFTP

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # necessÃ¡rio para comparar com commit anterior

      - name: ðŸ§ª Detectar arquivos modificados
        id: changed-files
        run: |
          echo "Detectando arquivos modificados no Ãºltimo commit..."
          git diff --name-only HEAD^ HEAD > changed_files.txt
          cat changed_files.txt

      - name: ðŸ“¦ Instalar cliente SSH
        run: sudo apt-get install -y sshpass

      - name: ðŸ“¡ Enviar arquivos modificados via SFTP
        env:
          SFTP_HOST: ${{ secrets.SFTP_HOST }}
          SFTP_USER: ${{ secrets.SFTP_USERNAME }}
          SFTP_PASS: ${{ secrets.SFTP_PASSWORD }}
          REMOTE_PATH: /home/storage/2/8d/40/barberflowtecnol1
        run: |
          # Garantir que variÃ¡veis estÃ£o presentes
          if [[ -z "$SFTP_HOST" || -z "$SFTP_USER" || -z "$SFTP_PASS" ]]; then
            echo "âŒ VariÃ¡veis de ambiente SFTP estÃ£o ausentes."
            exit 1
          fi

          while read file; do
            if [[ ! -f "$file" ]]; then
              echo "Ignorando (nÃ£o Ã© arquivo local): $file"
              continue
            fi

            TARGET_DIR="$REMOTE_PATH/$(dirname "$file")"
            DEST="$REMOTE_PATH/$file"

            echo "Enviando: $file â†’ $DEST"

            echo "sshpass -p [oculto] ssh $SFTP_USER@$SFTP_HOST mkdir -p \"$TARGET_DIR\""
            sshpass -p "$SFTP_PASS" ssh -o StrictHostKeyChecking=no "$SFTP_USER@$SFTP_HOST" "mkdir -p \"$TARGET_DIR\""

            echo "put \"$file\" \"$DEST\"" > sftp_batch.txt
            sshpass -p "$SFTP_PASS" sftp -o StrictHostKeyChecking=no -b sftp_batch.txt "$SFTP_USER@$SFTP_HOST"

          done < changed_files.txt

